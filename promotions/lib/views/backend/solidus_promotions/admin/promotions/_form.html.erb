<%= render partial: 'spree/shared/error_messages', locals: { target: @promotion } %>
<fieldset class="form-group no-border-bottom no-border-top">
  <div class="row">
    <div id="general_fields" class="col-9">
      <div class="row">
        <div class="col-12">
          <%= f.field_container :name do %>
            <%= f.label :name, class: 'required' %>
            <%= f.text_field :name, class: 'fullwidth', required: true %>
          <% end %>

          <%= f.field_container :customer_label do %>
            <%= f.label :customer_label, class: 'required' %>
            <%= f.text_field :customer_label, class: 'fullwidth', required: true %>
          <% end %>

          <%= f.field_container :description do %>
            <%= f.label :description %><br>
            <%= f.text_area :description, rows: 7, class: 'fullwidth' %>
            <span class="info">
              <%= t('spree.character_limit') %>
            </span>
          <% end %>

          <%= f.field_container :category do %>
            <%= f.label :promotion_category_id, SolidusPromotions::PromotionCategory.model_name.human %><br>
            <%=
              f.collection_select(:promotion_category_id, @promotion_categories, :id, :name, { include_blank: t('solidus_promotions.match_choices.none') },
              { class: 'custom-select fullwidth' })
            %>
          <% end %>
        </div>
      </div>
    </div>

    <div id="expiry_fields" class="col-3">
      <%= f.field_container :overall_usage_limit do %>
        <%= f.label :usage_limit %><br>
        <%= f.number_field :usage_limit, min: 0, class: 'fullwidth' %><br>
        <span class="info">
          <%= t('solidus_promotions.current_promotion_usage', count: @promotion.usage_count) %>
        </span>
      <% end %>

      <% if @promotion.persisted? %>
        <%= f.field_container :per_code_usage_limit do %>
          <%= f.label :per_code_usage_limit %><br>
          <%= f.number_field :per_code_usage_limit, min: 0, class: 'fullwidth' %><br>
        <% end %>
      <% end %>

      <div id="starts_at_field" class="form-group">
        <%= f.label :starts_at %>
        <%= f.field_hint :starts_at %>
        <%=
          f.text_field :starts_at,
          value: datepicker_field_value(@promotion.starts_at, with_time: true),
          placeholder: t(".starts_at_placeholder"),
          class: 'datepicker datepicker-from fullwidth',
          data: { :'enable-time' => true, :'default-hour' => 0 }
        %>
      </div>

      <div id="expires_at_field" class="form-group">
        <%= f.label :expires_at %>
        <%= f.field_hint :expires_at %>
        <%=
          f.text_field :expires_at,
          value: datepicker_field_value(@promotion.expires_at,
          with_time: true),
          placeholder: t(".expires_at_placeholder"),
          class: 'datepicker datepicker-to fullwidth',
          data: { :'enable-time' => true, :'default-hour' => 0 }
        %>
      </div>
      <div class="form-group">
        <%= f.field_container :lane do %>
          <%= f.label :lane %><br>
          <%=
            f.select(:lane, SolidusPromotions::Promotion.lane_options, {}, { class: 'custom-select fullwidth' })
          %>
        <% end %>
      </div>
    </div>
  </div>
</fieldset>

<fieldset class="no-border-bottom">
  <legend><%= t '.activation' %></legend>
  <div class="row">
    <div class="col-3">
      <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
        <button class="nav-link mb-1 active" id="v-pills-automatic-tab" data-toggle="pill" data-target="#v-pills-automatic" type="button" role="tab" aria-controls="v-pills-automatic" aria-selected="true">
          <%= t(".automatic") %>
        </button>
        <button class="nav-link mb-1" id="v-pills-path-tab" data-toggle="pill" data-target="#v-pills-path" type="button" role="tab" aria-controls="v-pills-path" aria-selected="false">
          <%= t(".path") %>
        </button>
        <button class="nav-link mb-1" id="v-pills-single-code-tab" data-toggle="pill" data-target="#v-pills-single-code" type="button" role="tab" aria-controls="v-pills-single-code" aria-selected="false">
          <%= t(".single_code") %>
        </button>
        <button class="nav-link mb-1" id="v-pills-multiple-codes-tab" data-toggle="pill" data-target="#v-pills-multiple-codes" type="button" role="tab" aria-controls="v-pills-multiple-codes" aria-selected="false">
          <%= t(".multiple_codes") %>
        </button>
      </div>
    </div>
    <div class="col-9">
      <div class="tab-content" id="v-pills-tabContent">
        <div class="tab-pane fade show active" id="v-pills-automatic" role="tabpanel" aria-labelledby="v-pills-automatic-tab">
          <%= f.field_container :apply_automatically do %>
            <%= f.label :apply_automatically do %>
              <%= f.check_box :apply_automatically, {disabled: !f.object.can_change_apply_automatically?, class: "#{'enable' if f.object.can_change_apply_automatically?}"} %>
              <%= SolidusPromotions::Promotion.human_attribute_name(:apply_automatically) %>
              <%= f.field_hint :promo_code_will_be_disabled %>
            <% end %>
            <% if f.object.codes.present? %>
              <div class="codes-present">
                <p>
                  <%= t('.codes_present') %>
                </p>
              </div>
            <% end %>
          <% end %>
        </div>
        <div class="tab-pane fade" id="v-pills-path" role="tabpanel" aria-labelledby="v-pills-path-tab">
          <%= f.field_container :path do %>
            <%= f.label :path %>
            <%= f.text_field :path, class: "fullwidth #{'enable' if f.object.can_change_path?}", disabled: true %>
          <% end %>
        </div>
        <div class="tab-pane fade" id="v-pills-single-code" role="tabpanel" aria-labelledby="v-pills-single-code-tab">
          <%= f.field_container :single_code do%>
            <%= label_tag :single_code, SolidusPromotions::PromotionCode.model_name.human %>
            <%= text_field_tag :single_code, @promotion.codes.first.try!(:value), class: "fullwidth #{'enable' if f.object.can_change_codes?}", disabled: true %>
          <% end %>
        </div>
        <div class="tab-pane fade" id="v-pills-multiple-codes" role="tabpanel" aria-labelledby="v-pills-multiple-codes-tab">
          <%= fields_for :promotion_code_batch, @promotion.code_batches.new do |batch| %>
            <%= render partial: 'solidus_promotions/admin/promotion_code_batches/form_fields', locals: {f: f, batch: batch, promotion: @promotion, disabled: true, promotion_id: params[:promotion_id]} %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</fieldset>

<script>
  function disableInactiveTabFields(event) {
    const panes = document.querySelectorAll(".tab-pane");
    panes.forEach(pane => {
      if (pane.id == event.target.dataset.target.slice(1)) {
        pane.querySelectorAll("input.enable, select.enable").forEach(input => {
          input.removeAttribute("disabled");
        });
      } else {
        pane.querySelectorAll("input, select").forEach(input => {
          input.setAttribute("disabled", true);
        });
      }
    });
  }
  document.addEventListener("DOMContentLoaded", function() {
    $(".nav-link").on("show.bs.tab", disableInactiveTabFields);
  });
</script>
